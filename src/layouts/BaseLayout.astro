---
import SiteHeader from '@components/SiteHeader.astro';
import SiteFooter from '@components/SiteFooter.astro';

import '../styles/tokens.css';
import '../styles/base.css';
import '../styles/components.css';
import '../styles/utilities.css';

interface Props {
  title: string;
  description: string;
  canonicalPath?: string;
  ogImage?: string;
  noIndex?: boolean;
}

const {
  title,
  description,
  canonicalPath = Astro.url.pathname,
  ogImage = '/banner.webp',
  noIndex = false
} = Astro.props;

const siteUrl = Astro.site ?? new URL('https://gracar.org');
const canonicalUrl = new URL(canonicalPath, siteUrl).toString();
const ogImageUrl = new URL(ogImage, siteUrl).toString();
const pageTitle = `${title} | Peter Gracar`;
const gaMeasurementId = 'G-PY7PCVWS5X';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="color-scheme" content="light dark" />
    <meta name="supported-color-schemes" content="light dark" />
    <meta name="theme-color" content="#f9f8f6" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#141213" media="(prefers-color-scheme: dark)" />
    <meta name="robots" content={noIndex ? 'noindex,nofollow' : 'index,follow'} />

    <title>{pageTitle}</title>
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Literata:opsz,wght@7..72,500;7..72,700&family=Source+Sans+3:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-PY7PCVWS5X');
    </script>
  </head>
  <body>
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <SiteHeader pathname={Astro.url.pathname} />
    <main id="main-content" class="site-main">
      <slot />
    </main>
    <SiteFooter />

    <script is:inline>
      (() => {
        const previews = Array.from(document.querySelectorAll('[data-hover-preview]'));
        if (previews.length === 0) return;

        const supportsHover = window.matchMedia('(hover: hover) and (pointer: fine)').matches;

        const setOpen = (preview, open) => {
          const trigger = preview.querySelector('[data-hover-trigger]');
          preview.classList.toggle('is-open', open);
          if (trigger) {
            trigger.setAttribute('aria-expanded', open ? 'true' : 'false');
          }
        };

        const closeAll = (except = null) => {
          previews.forEach((preview) => {
            if (except && preview === except) return;
            setOpen(preview, false);
          });
        };

        previews.forEach((preview) => {
          const trigger = preview.querySelector('[data-hover-trigger]');
          if (!trigger) return;

          trigger.addEventListener('click', (event) => {
            event.stopPropagation();
            const alreadyOpen = preview.classList.contains('is-open');
            closeAll(preview);
            setOpen(preview, !alreadyOpen);
          });

          trigger.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
              setOpen(preview, false);
              trigger.focus();
            }
          });

          preview.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
              setOpen(preview, false);
              trigger.focus();
            }
          });

          if (supportsHover) {
            preview.addEventListener('mouseenter', () => {
              closeAll(preview);
              setOpen(preview, true);
            });
            preview.addEventListener('mouseleave', () => setOpen(preview, false));

            trigger.addEventListener('focus', () => {
              closeAll(preview);
              setOpen(preview, true);
            });

            trigger.addEventListener('blur', () => {
              window.setTimeout(() => {
                if (!preview.contains(document.activeElement)) {
                  setOpen(preview, false);
                }
              }, 0);
            });
          }
        });

        document.addEventListener('click', (event) => {
          if (!(event.target instanceof Element)) return;
          if (event.target.closest('[data-hover-preview]')) return;
          closeAll();
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            closeAll();
          }
        });
      })();
    </script>
  </body>
</html>
