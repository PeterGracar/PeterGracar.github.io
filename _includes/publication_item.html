{% assign publication = include.publication %}
{% assign has_required_fields = publication.title and publication.title_url and publication.status %}
{% assign status_needs_date = publication.status == "preprint" or publication.status == "published" %}
{% assign has_required_date = true %}
{% if status_needs_date and publication.date == nil %}
  {% assign has_required_date = false %}
{% endif %}

{% if has_required_fields and has_required_date %}
  {% assign valid_coauthors = "" | split: "" %}
  {% if publication.coauthors %}
    {% assign valid_coauthors = publication.coauthors | where_exp: "coauthor", "coauthor.id and coauthor.name and coauthor.last_name" %}
  {% endif %}

  {% capture detail_line %}
    {% if publication.outlet_name %}
      <em>{% if publication.outlet_url %}<a href="{{ publication.outlet_url }}">{{ publication.outlet_name }}</a>{% else %}{{ publication.outlet_name }}{% endif %}</em>{% if publication.citation_text %}, {{ publication.citation_text }}{% endif %}
    {% elsif publication.preprint_label %}
      <em>{% if publication.preprint_url %}<a href="{{ publication.preprint_url }}">{{ publication.preprint_label }}</a>{% else %}{{ publication.preprint_label }}{% endif %}</em>
    {% endif %}
  {% endcapture %}
  {% assign detail_line = detail_line | strip %}

  <li>
    <strong><a href="{{ publication.title_url }}">{{ publication.title }}</a></strong>
    {% if valid_coauthors.size > 0 %}
      <br>with
      {% for coauthor in valid_coauthors %}
        {% if forloop.first == false %}{% if forloop.last %} and {% else %}, {% endif %}{% endif %}
        {% if coauthor.url %}<a href="{{ coauthor.url }}">{{ coauthor.name }}</a>{% else %}{{ coauthor.name }}{% endif %}
      {% endfor %}
      {% if detail_line != "" %}, {{ detail_line }}{% endif %}
    {% elsif detail_line != "" %}
      <br>{{ detail_line }}
    {% endif %}
    {% if publication.note %}
      <br><em>{{ publication.note }}</em>
    {% endif %}
  </li>
{% endif %}
